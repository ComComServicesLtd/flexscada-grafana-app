{"version":3,"sources":["../../../src/components/device/device_details.js"],"names":["_","DeviceDetailsCtrl","$scope","$injector","$location","$q","backendSrv","contextSrv","alertSrv","isOrgEditor","hasRole","pageReady","device","search","getDevice","set","id","self","get","then","resp","meta","code","msg","reject","body","getProbes","forEach","checks","check","route","type","probes","name","c","toLowerCase","mon","getMonitorByTypeName","enabled","state","sinceUpdate","Date","getTime","updated","frequency","states","duration","stateChange","secs","Math","floor","mins","hours","days","config","ids","probeList","p","tags","t","indexOf","keys","url","slug","path","checkType","healthSettings","notifications","addresses","split","list","addr","push","trim","emails","getNotificationEmails","length","email","res","match","join","templateUrl"],"mappings":"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","file":"device_details.js","sourcesContent":["import _ from 'lodash';\n\nclass DeviceDetailsCtrl {\n\n  /** @ngInject */\n  constructor($scope, $injector, $location,$q, backendSrv, contextSrv, alertSrv) {\n    this.isOrgEditor = contextSrv.hasRole(\"Admin\") || contextSrv.hasRole(\"Editor\");\n    this.backendSrv = backendSrv;\n    this.alertSrv = alertSrv;\n    this.$location = $location;\n    this.$q = $q;\n\n    this.pageReady = false;\n    this.device = null;\n\n    if ($location.search().device) {\n      this.getDevice($location.search().device);\n    } else {\n      this.alertSrv.set(\"no device id provided.\", \"\", 'error', 10000);\n    }\n\n  }\n\n\n  getDevice(id) {\n    var self = this;\n\n    self.backendSrv.get('api/plugin-proxy/flexscada-app/api/vibration/v1/config/'+id).then(function(resp) {\n      if (resp.meta.code !== 200) {\n        self.alertSrv.set(\"failed to get device.\", resp.meta.msg, 'error', 10000);\n        return self.$q.reject(resp.meta.msg);\n      }\n      self.device = resp.body;\n      var getProbes = false;\n      _.forEach(self.device.checks, function(check) {\n        if (check.route.type === 'byTags') {\n          getProbes = true;\n        }\n      });\n      if (getProbes) {\n        self.getProbes().then(() => {\n          self.pageReady = true;\n        });\n      } else {\n        self.pageReady = true;\n      }\n    });\n  }\n\n  getProbes() {\n    var self = this;\n    return self.backendSrv.get('api/plugin-proxy/flexscada-app/api/v2/probes').then(function(resp) {\n      if (resp.meta.code !== 200) {\n        self.alertSrv.set(\"failed to get probes.\", resp.meta.msg, 'error', 10000);\n        return self.$q.reject(resp.meta.msg);\n      }\n      self.probes = resp.body;\n    });\n  }\n\n  getMonitorByTypeName(name) {\n    var check;\n    _.forEach(this.device.checks, function(c) {\n      if (c.type.toLowerCase() === name.toLowerCase()) {\n        check = c;\n      }\n    });\n    return check;\n  }\n\n  monitorStateTxt(type) {\n    var mon = this.getMonitorByTypeName(type);\n    if (typeof(mon) !== \"object\") {\n      return \"disabled\";\n    }\n    if (!mon.enabled) {\n      return \"disabled\";\n    }\n    if (mon.state < 0 || mon.state > 2) {\n      var sinceUpdate = new Date().getTime() - new Date(mon.updated).getTime();\n      if (sinceUpdate < (mon.frequency * 5 * 1000)) {\n        return 'pending';\n      }\n      return 'nodata';\n    }\n    var states = [\"online\", \"warn\", \"critical\"];\n    return states[mon.state];\n  }\n\n  monitorStateClass(type) {\n    var mon = this.getMonitorByTypeName(type);\n    if (typeof(mon) !== \"object\") {\n      return \"disabled\";\n    }\n    if (!mon.enabled) {\n      return \"disabled\";\n    }\n    if (mon.state < 0 || mon.state > 2) {\n      return 'nodata';\n    }\n    var states = [\"online\", \"warn\", \"critical\"];\n    return states[mon.state];\n  }\n\n  stateChangeStr(type) {\n    var mon = this.getMonitorByTypeName(type);\n    if (typeof(mon) !== \"object\") {\n      return \"\";\n    }\n    var duration = new Date().getTime() - new Date(mon.stateChange).getTime();\n    if (duration < 10000) {\n      return \"a few seconds ago\";\n    }\n    if (duration < 60000) {\n      var secs = Math.floor(duration/1000);\n      return \"for \" + secs + \" seconds\";\n    }\n    if (duration < 3600000) {\n      var mins = Math.floor(duration/1000/60);\n      return \"for \" + mins + \" minutes\";\n    }\n    if (duration < 86400000) {\n      var hours = Math.floor(duration/1000/60/60);\n      return \"for \" + hours + \" hours\";\n    }\n    var days = Math.floor(duration/1000/60/60/24);\n    return \"for \" + days + \" days\";\n  }\n\n  getProbesForCheck(type) {\n    var check = this.getMonitorByTypeName(type);\n    if (typeof(check) !== \"object\") {\n      return [];\n    }\n    if (check.route.type === \"byIds\") {\n      return check.route.config.ids;\n    } else if (check.route.type === \"byTags\") {\n      var probeList = {};\n      _.forEach(this.probes, function(p) {\n        _.forEach(check.route.config.tags, function(t) {\n          if (_.indexOf(p.tags, t) !== -1) {\n            probeList[p.id] = true;\n          }\n        });\n      });\n      return _.keys(probeList);\n    } else {\n      this.alertSrv(\"check has unknown routing type.\", \"unknown route type.\", \"error\", 5000);\n      return [];\n    }\n  }\n\n  setDevice(id) {\n    this.$location.url('plugins/flexscada-app/page/device_details?device='+id);\n  }\n\n  gotoDashboard(device, type) {\n    if (!type) {\n      type = 'summary';\n    }\n    var search = {\n      \"var-probe\": \"All\",\n      \"var-device\": device.slug\n    };\n    switch(type.toLowerCase()) {\n      case \"summary\":\n        this.$location.path(\"/dashboard/db/flexscada-device-summary\").search(search);\n        break;\n      case \"ping\":\n        this.$location.path(\"/dashboard/db/flexscada-device-ping\").search(search);\n        break;\n      case \"dns\":\n        this.$location.path(\"/dashboard/db/flexscada-device-dns\").search(search);\n        break;\n      case \"http\":\n        search['var-protocol'] = \"http\";\n        this.$location.path(\"/dashboard/db/flexscada-device-web\").search(search);\n        break;\n      case \"https\":\n        search['var-protocol'] = \"https\";\n        this.$location.path(\"/dashboard/db/flexscada-device-web\").search(search);\n        break;\n      default:\n        this.$location.path(\"/dashboard/db/flexscada-device-summary\").search(search);\n        break;\n    }\n  }\n\n  gotoEventDashboard(device, type) {\n    this.$location.url(\"/dashboard/db/flexscada-events\").search({\n      \"var-probe\": \"All\",\n      \"var-device\": device.slug,\n      \"var-monitor_type\": type.toLowerCase()\n    });\n  }\n\n  getNotificationEmails(checkType) {\n    var mon = this.getMonitorByTypeName(checkType);\n    if (!mon || mon.healthSettings.notifications.addresses === \"\") {\n      return [];\n    }\n    var addresses = mon.healthSettings.notifications.addresses.split(',');\n    var list = [];\n    addresses.forEach(function(addr) {\n      list.push(addr.trim());\n    });\n    return list;\n  }\n\n  getNotificationEmailsAsString(checkType) {\n    var emails = this.getNotificationEmails(checkType);\n    if (emails.length < 1) {\n      return \"No recipients specified\";\n    }\n    var list = [];\n    emails.forEach(function(email) {\n      // if the email in the format `display name <email@address>`\n      // then just show the display name.\n      var res = email.match(/\\\"?(.+)\\\"?\\s*<.*@.*>/);\n      if (res && res.length === 2) {\n        list.push(res[1]);\n      } else {\n        list.push(email);\n      }\n    });\n    return list.join(\", \");\n  }\n}\n\nDeviceDetailsCtrl.templateUrl = 'public/plugins/flexscada-app/components/device/partials/device_details.html';\nexport {DeviceDetailsCtrl};\n"]}