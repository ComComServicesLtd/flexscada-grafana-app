<link rel="stylesheet" href="public/plugins/flexscada-app/css/font-awesome.min.css">
 <div ng-if="ctrl.deviceStatus == 0" >
 <div class="page-header">
    <h1>Add New Alarm</h1>
  </div>
  <div class="row">
    <div class="col-md-10">
      <p>Alarm rules are used to identify abnormal conditions and provide awarness before process are affected</p>
    </div>
  </div>
</div>


  <div ng-if="ctrl.deviceStatus == 1" class="page-header">
    <h1>{{ctrl.config.name}}</h1>
    
    
    


     <a class="btn btn-link pull-right" href="plugins/flexscada-app/page/devices"><i class="fa fa-mail-reply" aria-hidden="true"></i>&nbsp;Back to alarm list</a>
 

  </div>




    <!-- New device -->
    <div class="gf-form-group" ng-if="ctrl.deviceStatus == 0">
      <!-- Below replaces header area on submit -->

      <div class="gf-form-inline">
        <div class="gf-form gf-form--right-margin">
          <label class="gf-form-label width-9">Alarm Name</label>
          <input class="gf-form-input max-width-15" type="text" ng-model="ctrl.config.name" required="" placeholder="8x6 Pumps">
        </div>
        <!-- Unsubmitted state -->
        <div class="gf-form">
          <button class="btn btn-success" ng-click="ctrl.addAlarm()">Next</button>
        </div>

      </div>

    </div>


    
    <div ng-if="ctrl.deviceStatus > 0">
         <div class="gf-form-inline">
         <div class="gf-form gf-form--right-margin">
          <label class="gf-form-label width-9">Alarm Name</label>
          <input class="gf-form-input max-width-15" type="text" ng-model="ctrl.config.name" ng-class="{ 'fs-text-box-success' : ctrl.discovered, 'fs-font-shrinker' : ctrl.config.name > 10 }" placeholder="6X9 Pump">
        </div>
        </div>
                  <div class="gf-form gf-form--v-stretch">
              <label class="gf-form-label width-9">Description</label>
              <textarea class="gf-form-input max-width-30" type="textarea" ng-model="ctrl.config.desc"></textarea>
              <info-popover>Describe how this alarm rule is to be used and any other relevant details.</info-popover>
            </div>
            <br><br>
       <h3 class="page-headering">Notifications</h3>
       <hr>
			<div class="gf-form-inline">
				<div class="gf-form max-width-30">
					<span class="gf-form-label width-8">Send to</span>
					<span class="gf-form-label" ng-repeat="nc in ctrl.alertNotifications" ng-style="{'background-color': nc.bgColor }">
						<i class="{{nc.iconClass}}"></i>&nbsp;{{nc.name}}&nbsp;
						<i class="fa fa-remove pointer muted" ng-click="ctrl.removeNotification($index)" ng-if="nc.isDefault === false"></i>
					</span>
					<metric-segment segment="ctrl.addNotificationSegment" get-options="ctrl.getNotifications()" on-change="ctrl.notificationAdded()"></metric-segment>
				</div>
			</div>
			<div class="gf-form gf-form--v-stretch">
				<span class="gf-form-label width-8">Message</span>
				<textarea class="gf-form-input width-20" rows="5" ng-model="ctrl.alert.message"  placeholder="Notification message details..."></textarea>
				 <info-popover>This message will be sent with each alarm notification</info-popover>
			</div>
            <br><br>
 <h3 class="page-headering">Selection Rules</h3>
 <hr>
                 <div class="gf-form">
    <span class="gf-form-label width-12">Device has tags</span>
    <bootstrap-tagsinput ng-model="ctrl.config.devicetags" tagclass="label fs-label-tag" placeholder="Add tags"></bootstrap-tagsinput>
     <info-popover>The Alarm rule will target devices that contain each of these tags</info-popover>
  </div>
  
                   <div class="gf-form">
    <span class="gf-form-label width-12">Channel has tags</span>
    <bootstrap-tagsinput ng-model="ctrl.config.channeltags" tagclass="label fs-label-tag" placeholder="Add tags"></bootstrap-tagsinput>
     <info-popover>The Alarm rule will target channels on the matching devices that contain each of these tags</info-popover>
  </div>
  
  
   <br>
   <br>
    <h3 class="page-headering">Fault Detection</h3>
<hr>
            
            
                   <div class="gf-form">
                <span class="gf-form-label width-12">Detection Method</span>
                     <div class="gf-form-select-wrapper">
                <select class="gf-form-input gf-size-auto" ng-model="ctrl.config.detectionMethod" ng-options="f.value as f.text for f in ctrl.detectionMethods" ng-change="ctrl.refresh()"></select>
            </div><info-popover>Automatic detection methods are incredibly accurate and are reccomended for most sitatuions however for specialized equiptment, manual condition rules are available.</info-popover>
            </div>
            
            <div ng-if="ctrl.config.detectionMethod != 'rule' && ctrl.config.detectionMethod.length > 2">
            
                               <div class="gf-form">
                <span class="gf-form-label width-12">Sensitvity</span>
                     <div class="gf-form-select-wrapper">
                <select class="gf-form-input gf-size-auto" ng-model="ctrl.config.senitivity" ng-init="ctrl.config.senitivity='medium'" ng-options="f.value as f.text for f in ctrl.senitivitySettings" ng-change="ctrl.refresh()"></select>
            </div>
            </div>

            
            </div>

              <div  ng-if="ctrl.config.detectionMethod == 'rule'">

                               <div class="gf-form">
                <span class="gf-form-label width-12">FFT Bins</span>
                     <div class="gf-form-select-wrapper">
                <select class="gf-form-input gf-size-auto" ng-model="ctrl.config.bins" ng-init="ctrl.config.bins=1024" ng-options="f.value as f.text for f in ctrl.binOptions" ng-change="ctrl.refresh()"></select>
            </div><info-popover>Depending on the application, downconverting to a lower number of bins may increase detection performance. We reccomend you visualize the data at different bin counts and find what works best for your application.  If you're not sure what to choose here select 1024.</info-popover>
            </div>

            <div class="gf-form">
                <span class="gf-form-label width-12">FFT Aggergation</span>
                     <div class="gf-form-select-wrapper">
                <select class="gf-form-input gf-size-auto" ng-model="ctrl.config.frequencyAggregation"  ng-init="ctrl.config.frequencyAggregation='max'" ng-options="f.value as f.text for f in ctrl.aggregationMethods" ng-change="ctrl.refresh()"></select>
            </div><info-popover>When downconverting a 1024 point fft to a 256 point fft we will combine several fft bins together, choosing average as the mode will average the amplitude of all of the bins while selecting maximum will downsample to the amplitude of the bin with the highest amplitude.  If you're not sure what to choose here select maximum.</info-popover>
            </div>
            
                                           <div class="gf-form">
                <span class="gf-form-label width-12">Timespan for Average</span>
                     <div class="gf-form-select-wrapper">
                <select class="gf-form-input gf-size-auto" ng-model="ctrl.config.averageTimespan" ng-init="ctrl.config.averageTimespan=2678400" ng-options="f.value as f.text for f in ctrl.averagingSpans" ng-change="ctrl.refresh()"></select>
            </div><info-popover>This is used for condition rules that compare against average values, if a six month period is selected, the amplitude for each frequency will be averaged over six months.  A timespan of around 6 months is reccomend for most applications.</info-popover>
            </div>
            

              <br><br>
      <div ng-include src="'public/plugins/flexscada-app/components/alarm/partials/alarmConditions.html'"></div>
      </div>
    
    
    </div>
   <br><br>
  <div ng-show="ctrl.deviceStatus == 1" ng-include src="'public/plugins/flexscada-app/components/alarm/partials/destroyForm.html'"></div>
 
  <div ng-show="ctrl.deviceStatus > 0" class="pull-right">
      <button type="submit" ng-if="ctrl.deviceStatus == 0" class="btn btn-success" ng-click="ctrl.saveDevice()">Add</button>
      <button type="submit" ng-if="ctrl.deviceStatus == 1" class="btn btn-success" ng-click="ctrl.saveDevice()">Save</button>
      
      <a class="btn btn-link" ng-click="ctrl.cancel();">Cancel</a>
  </div>
  
  
</div>
